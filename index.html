<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeamPro Engineering</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #cbd5e1; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 font-sans overflow-hidden h-screen flex flex-col">

    <!-- Шапка -->
    <header class="h-14 bg-white border-b px-6 flex justify-between items-center shadow-sm shrink-0">
        <div class="flex items-center gap-2.5">
            <div class="bg-blue-600 p-1.5 rounded-lg shadow-blue-200 shadow-md">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg>
            </div>
            <span class="font-bold text-slate-800 tracking-tight text-lg">BeamPro <span class="text-blue-600">Engineering</span></span>
        </div>
        <div class="flex gap-3">
            <button onclick="analyzeAI('analyze')" id="ai-btn" class="flex items-center gap-2 px-3.5 py-1.5 bg-white border border-blue-200 text-blue-700 rounded-full text-xs font-semibold hover:bg-blue-50 transition-all shadow-sm active:scale-95">
                Анализ ИИ
            </button>
            <button onclick="analyzeAI('report')" class="flex items-center gap-2 px-3.5 py-1.5 bg-slate-900 text-white rounded-full text-xs font-semibold hover:bg-slate-800 transition-all shadow-md active:scale-95">
                Отчет
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Боковая панель -->
        <aside class="w-80 bg-white border-r flex flex-col shrink-0 overflow-y-auto custom-scrollbar p-5 space-y-8">
            <section>
                <label class="text-xs font-semibold text-slate-600 mb-3 block text-center">Тип закрепления</label>
                <div class="grid grid-cols-2 gap-2 p-1 bg-slate-100 rounded-xl">
                    <button id="fix-left" onclick="setFix('left')" class="py-2 text-[11px] font-bold rounded-lg bg-white text-blue-600 shadow-sm">Слева</button>
                    <button id="fix-right" onclick="setFix('right')" class="py-2 text-[11px] font-bold rounded-lg text-slate-500">Справа</button>
                </div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <label class="text-xs font-semibold text-slate-600">Участки</label>
                    <button onclick="addSegment()" class="text-blue-600 p-1 hover:bg-blue-50 rounded">+</button>
                </div>
                <div id="segments-list" class="space-y-4"></div>
            </section>

            <section>
                <div class="flex justify-between items-center mb-4">
                    <label class="text-xs font-semibold text-slate-600">Силы F</label>
                    <button onclick="addLoad()" class="text-blue-600 p-1 hover:bg-blue-50 rounded">+</button>
                </div>
                <div id="loads-list" class="space-y-3"></div>
            </section>
        </aside>

        <!-- Рабочая зона -->
        <main class="flex-1 bg-slate-50 flex flex-col relative overflow-hidden">
            <div class="flex-1 flex items-center justify-center p-8">
                <div class="bg-white p-6 rounded-[2rem] shadow-xl border border-white relative">
                    <canvas id="mainCanvas" width="800" height="580"></canvas>
                </div>
            </div>
            
            <div id="ai-panel" class="hidden h-64 bg-[#0f172a] text-slate-200 p-8 overflow-y-auto border-t border-slate-800">
                <div class="max-w-4xl mx-auto">
                    <div class="flex justify-between mb-4">
                        <h3 class="font-bold text-white">Интеллектуальный разбор</h3>
                        <button onclick="closeAI()" class="text-slate-500 hover:text-white">✕</button>
                    </div>
                    <div id="ai-content" class="text-sm leading-relaxed opacity-90 whitespace-pre-wrap"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Используем более уникальные имена для глобальных констант, чтобы избежать SyntaxError
        let segments = [{ id: 1, length: 0.7, diameter: 0.034, q: 1.4 }];
        let loads = [{ id: 1, position: 0.7, value: 0 }];
        let fixedEnd = 'left';
        const YOUNG_MODULUS = 2e11; // Переименовано из E во избежание конфликтов переопределения
        const apiKey = "";

        function setFix(side) {
            fixedEnd = side;
            document.getElementById('fix-left').className = side === 'left' ? 'py-2 text-[11px] font-bold rounded-lg bg-white text-blue-600 shadow-sm' : 'py-2 text-[11px] font-bold rounded-lg text-slate-500';
            document.getElementById('fix-right').className = side === 'right' ? 'py-2 text-[11px] font-bold rounded-lg bg-white text-blue-600 shadow-sm' : 'py-2 text-[11px] font-bold rounded-lg text-slate-500';
            render();
        }

        function addSegment() {
            segments.push({ id: Date.now(), length: 0.5, diameter: 0.03, q: 0 });
            render();
        }

        function addLoad() {
            loads.push({ id: Date.now(), position: 0, value: 0 });
            render();
        }

        function updateSeg(id, field, val) {
            const s = segments.find(x => x.id === id);
            if (s) s[field] = parseFloat(val) || 0;
            render();
        }

        function updateLoad(id, field, val) {
            const l = loads.find(x => x.id === id);
            if (l) l[field] = parseFloat(val) || 0;
            render();
        }

        function removeSeg(id) {
            if (segments.length > 1) {
                segments = segments.filter(x => x.id !== id);
                render();
            }
        }

        function removeLoad(id) {
            loads = loads.filter(x => x.id !== id);
            render();
        }

        function calculate() {
            const totalLength = segments.reduce((a, b) => a + b.length, 0);
            const totalExt = segments.reduce((a, b) => a + (b.q * b.length), 0) + loads.reduce((a, b) => a + b.value, 0);
            const reaction = -totalExt;
            
            const points = [];
            let curX = 0;
            segments.forEach(seg => {
                for(let i=0; i<=20; i++) points.push({x: curX + (seg.length * i / 20)});
                curX += seg.length;
            });

            const data = points.map(p => {
                let N = 0;
                if (fixedEnd === 'left') {
                    N += reaction;
                    let cursor = 0;
                    segments.forEach(s => {
                        if (p.x >= cursor + s.length) N += s.q * s.length;
                        else if (p.x > cursor) N += s.q * (p.x - cursor);
                        cursor += s.length;
                    });
                    loads.forEach(l => { if (l.position <= p.x + 1e-7) N += l.value; });
                } else {
                    let sumR = 0;
                    let cursor = 0;
                    segments.forEach(s => {
                        const end = cursor + s.length;
                        if (p.x < cursor) sumR += s.q * s.length;
                        else if (p.x < end) sumR += s.q * (end - p.x);
                        cursor += s.length;
                    });
                    loads.forEach(l => { if (l.position > p.x + 1e-7) sumR += l.value; });
                    N = sumR + reaction;
                }

                const seg = segments.find((_, i) => {
                    let s = segments.slice(0, i).reduce((a, b) => a + b.length, 0);
                    return p.x <= s + segments[i].length + 1e-7;
                }) || segments[segments.length-1];

                const A = Math.PI * (seg.diameter ** 2) / 4;
                return { x: p.x, N, Sigma: N/A, A };
            });

            let Delta = 0;
            const final = data.map((pt, i) => {
                if (i > 0) {
                    const prev = data[i-1];
                    const dx = pt.x - prev.x;
                    Delta += (((prev.N/(prev.A * YOUNG_MODULUS)) + (pt.N/(pt.A * YOUNG_MODULUS)))/2) * dx;
                }
                return { ...pt, Delta };
            });

            if (fixedEnd === 'right') {
                const totalD = final[final.length-1].Delta;
                final.forEach(d => d.Delta -= totalD);
            }

            return { data: final, totalLength };
        }

        function draw() {
            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d');
            const { width, height } = canvas;
            ctx.clearRect(0,0,width,height);

            const { data, totalLength } = calculate();
            const margin = { left: 80, right: 60 };
            const scaleX = (width - margin.left - margin.right) / totalLength;
            const toX = x => margin.left + x * scaleX;

            // Стержень
            let curX = 0;
            const maxD = Math.max(...segments.map(s => s.diameter));
            segments.forEach(s => {
                const h = (s.diameter / maxD) * 40;
                ctx.fillStyle = "#e2e8f0";
                ctx.strokeStyle = "#475569";
                ctx.fillRect(toX(curX), 60 - h/2, s.length * scaleX, h);
                ctx.strokeRect(toX(curX), 60 - h/2, s.length * scaleX, h);
                curX += s.length;
            });

            // Эпюры
            const plots = [
                { k: 'N', y: 180, c: '#ef4444', l: 'N [Н]' },
                { k: 'Sigma', y: 340, c: '#f59e0b', l: 'σ [Па]' },
                { k: 'Delta', y: 500, c: '#8b5cf6', l: 'Δl [м]' }
            ];

            plots.forEach(p => {
                const vals = data.map(d => d[p.k]);
                const max = Math.max(...vals.map(Math.abs), 1e-9);
                const sy = 50 / max;

                ctx.strokeStyle = "#cbd5e1";
                ctx.setLineDash([5,5]);
                ctx.beginPath(); ctx.moveTo(margin.left, p.y); ctx.lineTo(width-margin.right, p.y); ctx.stroke();
                ctx.setLineDash([]);

                ctx.beginPath();
                ctx.strokeStyle = p.c;
                ctx.lineWidth = 2;
                data.forEach((d, i) => {
                    const x = toX(d.x);
                    const y = p.y - d[p.k] * sy;
                    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                });
                ctx.stroke();
                ctx.fillStyle = p.c + "10";
                ctx.lineTo(toX(totalLength), p.y); ctx.lineTo(toX(0), p.y); ctx.fill();
                
                ctx.fillStyle = "#1e293b"; ctx.font = "bold 10px sans-serif";
                ctx.fillText(p.l, 10, p.y + 4);
            });
        }

        function render() {
            const sList = document.getElementById('segments-list');
            sList.innerHTML = segments.map(s => `
                <div class="p-3 bg-slate-50 rounded-xl border relative">
                    <button onclick="removeSeg(${s.id})" class="absolute -right-2 -top-2 bg-white border rounded-full w-5 h-5 text-[10px]">×</button>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.1" value="${s.length}" onchange="updateSeg(${s.id}, 'length', this.value)" class="border rounded p-1 text-xs">
                        <input type="number" step="0.001" value="${s.diameter}" onchange="updateSeg(${s.id}, 'diameter', this.value)" class="border rounded p-1 text-xs">
                        <input type="number" value="${s.q}" onchange="updateSeg(${s.id}, 'q', this.value)" class="col-span-2 border rounded p-1 text-xs">
                    </div>
                </div>
            `).join('');

            const lList = document.getElementById('loads-list');
            lList.innerHTML = loads.map(l => `
                <div class="flex gap-2 bg-white border p-2 rounded-lg items-center">
                    <input type="number" step="0.1" value="${l.position}" onchange="updateLoad(${l.id}, 'position', this.value)" class="w-16 border rounded p-1 text-xs">
                    <input type="number" value="${l.value}" onchange="updateLoad(${l.id}, 'value', this.value)" class="w-16 border rounded p-1 text-xs">
                    <button onclick="removeLoad(${l.id})" class="text-red-400">×</button>
                </div>
            `).join('');

            draw();
        }

        async function analyzeAI(mode) {
            const btn = document.getElementById('ai-btn');
            btn.disabled = true; btn.innerText = "Загрузка...";
            
            const prompt = `Проанализируй стержень. Участки: ${JSON.stringify(segments)}. Силы: ${JSON.stringify(loads)}. Заделка: ${fixedEnd}.`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const res = await response.json();
                document.getElementById('ai-panel').classList.remove('hidden');
                document.getElementById('ai-content').innerText = res.candidates[0].content.parts[0].text;
            } catch (e) {
                alert("Ошибка ИИ");
            } finally {
                btn.disabled = false; btn.innerText = "Анализ ИИ";
            }
        }

        function closeAI() { document.getElementById('ai-panel').classList.add('hidden'); }

        window.onload = render;
    </script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js');
    });
  }
</script>
</body>
</html>